<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>타이머</title>
    <style>
        @font-face {
            font-family: nanum;
            src: url(res/NSL.ttf);
        }

        html, body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "nanum";
        }

        svg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #clock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #clockTime {
            font-size: min(10vh, 10vw);
            margin: 2px;
            padding: 0;
            cursor: pointer;
            text-align: center;
        }

        #clockTimeInput {
            font-size: min(10vh, 10vw);
            border: none;
            width: min(42vh, 42vw);
            font-family: nanum;
            text-align: center;
            outline: none;
        }

        a {
            font-size: 30px;
            text-decoration: none;
            color: #5451c4;
            font-size: min(5vh, 5vw);
        }

        #clockTimeForm {
            text-align: center;
            margin: 0;
            padding: 0;
        }

        #clockCancel {
            width: 100%;
            text-align: center;
            bottom: 10px;
            cursor: pointer;
        }

        #clockWorkForm {
            text-align: center;
        }
    </style>
</head>
<body oncontextmenu="return false;">
<script>
    getVal = require('electron').remote.getGlobal;
    const {ipcRenderer} = require('electron');
    let isMouseOver = false;

    function mouseStatus(val) {
        isMouseOver = val;
    }

    function togglePause() {
        if (getVal('isPaused').value) {
            getVal('isPaused').value = false;
            ipcRenderer.send('resumeTimer', 'Timer');
        } else {
            getVal('isPaused').value = true;
            ipcRenderer.send('pauseTimer', 'Timer');
        }
    }

    function getCaretPosition(ctrl) {
        let CaretPos = 0;
        if (ctrl.selectionStart || ctrl.selectionStart == 0) {// Standard.
            CaretPos = ctrl.selectionStart;
        } else if (document.selection) {// Legacy IE
            ctrl.focus();
            var Sel = document.selection.createRange();
            Sel.moveStart('character', -ctrl.value.length);
            CaretPos = Sel.text.length;
        }
        return (CaretPos);
    }


    function setCaretPosition(ctrl, pos) {
        if (ctrl.setSelectionRange) {
            ctrl.focus();
            ctrl.setSelectionRange(pos, pos);
        } else if (ctrl.createTextRange) {
            var range = ctrl.createTextRange();
            range.collapse(true);
            range.moveEnd('character', pos);
            range.moveStart('character', pos);
            range.select();
        }
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function updateArc(radius, startAngle, endAngle) {

        const start = polarToCartesian(220, 220, radius, endAngle);
        const end = polarToCartesian(220, 220, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

        const d = [
            "M", start.x, start.y,
            "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
        ].join(" ");
        document.getElementById("leftTime").setAttribute("d", d);
        document.getElementById("timeSelector").setAttribute("cx", start.x);
        document.getElementById("timeSelector").setAttribute("cy", start.y);
        return d;
    }

    function formatTime(sec) {
        const h = ("0" + Math.floor(sec / 3600)).slice(-2);
        const m = ("0" + Math.floor(sec / 60) % 60).slice(-2);
        const s = ("0" + sec % 60).slice(-2);
        return h + ":" + m + ":" + s;
    }

    setInterval(function () {
        const r = getVal('r').value;
        updateArc(150, 0, r * 360);
        if (r >= 1) {
            updateArc(150, 0, 359.99);
        }
        if (r) {
            document.getElementById('clockWorkForm').style.display = '';
            document.getElementById('clockTimeForm').style.display = 'none';
            if (getVal('isPaused').value) {
                if (isMouseOver) document.getElementById('clockTime').innerText = "클릭해서\n계속";
                else document.getElementById('clockTime').innerText = "일시정지됨\n" + formatTime(Math.round(r * getVal('setTime').value));
            } else {
                if (isMouseOver) document.getElementById('clockTime').innerText = "클릭해서\n일시정지";
                else document.getElementById('clockTime').innerText = formatTime(Math.round(r * getVal('setTime').value));
            }
        } else {
            document.getElementById('clockWorkForm').style.display = 'none';
            document.getElementById('clockTimeForm').style.display = '';
        }
    }, 1);

    function startTimer() {
        const str = document.getElementById('clockTimeInput').value.replace(/\D+/g, '');
        let time = 0;
        time += parseInt(str.substr(0, 2)) * 3600;
        time += parseInt(str.substr(2, 2)) * 60;
        time += parseInt(str.substr(4, 2));
        getVal('setTime').value = time;
        getVal('isPaused').value = false;
        ipcRenderer.send('startTimer', 'Timer');
    }

    function cancelTimer() {
        ipcRenderer.send('stopTimer', 'Timer');
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('clockTimeInput').value = "00:00:00";
        document.getElementById('clockTimeInput').addEventListener('input', () => {
            const rawStr = document.getElementById('clockTimeInput').value;
            const str = rawStr.replace(/\D+/g, '');
            let resStr;
            let pos = getCaretPosition(document.getElementById('clockTimeInput'));
            let numPos = 0;
            for (i = 0; i < pos; i++) {
                if (/^\d+$/.test(rawStr[i])) numPos++;
            }
            if (str.length > 6) {
                resStr = str.substr(0, numPos - (str.length - 6) + 1) + str.substr(numPos + 1);
                if (numPos % 2 === 0 && pos > 0) pos++;
            } else if (str.length < 6) {
                resStr = str.substr(0, numPos) + '0'.repeat(6 - str.length) + str.substr(numPos);
                if (numPos % 2 === 0 && pos > 0) pos--;
            } else resStr = str;
            resStr = resStr.substr(0, 6);
            resStr = resStr.substr(0, 2) + ':' + resStr.substr(2, 2) + ':' + resStr.substr(4, 2);
            document.getElementById('clockTimeInput').value = resStr;
            setCaretPosition(document.getElementById('clockTimeInput'), pos);
        });
    })
</script>
<svg style="max-width:90vw;max-height: 90vh;" viewBox="0 0 440 440">
    <defs>
        <filter id="filter1" x="-30%" y="-30%" width="200%" height="200%">
            <feOffset result="offOut" in="SourceAlpha" dx="5" dy="5"/>
            <feGaussianBlur result="blurOut" in="offOut" stdDeviation="10"/>
            <feColorMatrix in="blurOut" result="colorOut" type="matrix"
                           values="0 0 0 0   0
              0 0 0 0   0
              0 0 0 0   0
              0 0 0 0.4 0"/>
            <feBlend in="SourceGraphic" in2="colorOut" mode="normal"/>
        </filter>
        <filter id="innershadow" x0="-50%" y0="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="5" result="blur"></feGaussianBlur>
            <feOffset dy="2" dx="3"></feOffset>
            <feComposite in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowDiff"></feComposite>

            <feFlood flood-color="#444444" flood-opacity="0.2"></feFlood>
            <feComposite in2="shadowDiff" operator="in"></feComposite>
            <feComposite in2="SourceGraphic" operator="over" result="firstfilter"></feComposite>


            <feGaussianBlur in="firstfilter" stdDeviation="5" result="blur2"></feGaussianBlur>
            <feOffset dy="-2" dx="-3"></feOffset>
            <feComposite in2="firstfilter" operator="arithmetic" k2="-1" k3="1" result="shadowDiff"></feComposite>

            <feFlood flood-color="#444444" flood-opacity="0.2"></feFlood>
            <feComposite in2="shadowDiff" operator="in"></feComposite>
            <feComposite in2="firstfilter" operator="over"></feComposite>
        </filter>
        <linearGradient id="MyGradient" gradientTransform="rotate(65)">
            <stop offset="5%" stop-color="#ffffff"/>
            <stop offset="95%" stop-color="#f2f6ff"/>
        </linearGradient>
    </defs>
    <path fill="none" stroke="#f2f6ff" stroke-width="40"
          d="M 219.9997382006122 70.00000000022845 A 150 150 0 1 0 220 70" filter="url(#innershadow)"></path>
    <path id="leftTime" fill="none" stroke="#5451c4" stroke-width="40"></path>
    <circle cx="220" cy="70" id="timeSelector" r="30" fill="url(#MyGradient)" filter="url(#filter1)"/>
</svg>
<div id="clock">
    <div id="clockWorkForm">
        <p id="clockTime" onmouseover="mouseStatus(true);" onmouseout="mouseStatus(false);"
           onclick="togglePause();"></p>
        <div style="width:100%;height: 15px;"></div>
        <a id="clockCancel" onclick="cancelTimer();">정지</a>
    </div>
    <form id="clockTimeForm">
        <input type="text" id="clockTimeInput"><br>
        <div style="width:100%;height: 15px;"></div>
        <a id="close" href="#" onclick="startTimer();">시작</a>
    </form>
</div>
</body>
</html>